<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de reserva de stock</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1, h2 {
            text-align: center;
            width: 100%;
            margin-top: 10px;
        }

        h2 {
            font-weight: bold;
        }

        .container {
            width: 90%;
            max-width: 1200px; /* Limitar el ancho máximo en pantallas grandes */
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        /* Formulario responsivo usando CSS Grid */
        .form-container {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Ajustes para pantallas pequeñas */
        @media (max-width: 768px) {
            .form-container {
                grid-template-columns: 1fr; /* En pantallas más pequeñas, los campos estarán en una sola columna */
            }
        }

        .form-container input,
        .form-container select,
        .form-container button {
            width: 100%;
            font-size: 16px;
            padding: 12px;
            text-align: center;
            border-radius: 5px;
        }

        .form-container button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .form-container button:hover {
            background-color: #45a049;
        }

        /* Estilo para botones de acción */
        .action-button {
            background-color: #007bff;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px;
        }

        .action-button:hover {
            background-color: #0056b3;
        }

        /* Estilo para el botón de terminar proceso */
        .finish-button {
            background-color: #007bff;
            color: white;
            font-size: 18px;
            padding: 15px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            margin-top: 20px;
            width: 100%;
        }

        .finish-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        .checkboxes-container {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            margin-top: 10px;
        }

        .checkboxes-container input {
            margin-right: 10px;
        }

        .table-container {
            width: 100%;
            margin-top: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #ccc;
            text-align: center;
            padding: 8px;
        }

        th {
            background-color: #f4f4f4;
        }

        .completed {
            background-color: #d4edda;
            animation: fadeOut 1s forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0.6;
            }
        }

        #total {
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            margin-top: 20px;
        }

        #qrForm {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        #qrcode {
            margin-top: 20px;
            display: inline-block;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            z-index: 1000;
            display: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
<body>

<h1>RESERVA DE STOCK</h1>

<!-- Segundo título dinámico que cambiará en tiempo real -->
<h2 id="numeroReservaTitulo">Número de reserva: </h2>

<div class="container">

    <!-- Formulario de consulta -->
    <div class="form-container">
        <!-- Campo de búsqueda de reserva -->
        <div>
            <label for="searchInput">Consulta de reserva stock</label><br>
            <input type="text" id="searchInput" placeholder="Buscar por número de reserva" oninput="updateNumeroReserva()" />
        </div>

        <!-- Selección de Pikeador -->
        <div>
            <label for="pikeador">Seleccionar Pikeador:</label><br>
            <select id="pikeadorSelect" onchange="filterByPikeador()">
                <option value="">Seleccione un Pikeador</option>
                <!-- Los nombres de los pikeadores se agregarán aquí dinámicamente -->
            </select>
        </div>
    </div>

    <!-- Checkboxes de estado -->
    <div class="checkboxes-container">
        <label><input type="checkbox" id="pendienteCheckbox" onchange="filterByState()"> Pendiente</label>
        <label><input type="checkbox" id="terminadoCheckbox" onchange="filterByState()"> Terminado</label>
    </div>

    <!-- Tabla con los datos de los artículos -->
    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Línea</th>
                    <th>Código</th>
                    <th>Artículo</th>
                    <th>Stock</th>
                    <th>Por preparar</th>
                    <th>Unidades preparadas</th>
                    <th>Estado</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                <!-- Los datos se llenarán aquí con JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Información adicional -->
    <div id="total">Total por preparar: 0</div>

    <!-- Botón de "Terminar todo el proceso" -->
    <button id="finishButton" class="finish-button" onclick="finishProcess()" disabled>Terminar todo el proceso</button>

    <!-- Generación de QR -->
    <div id="qrForm">
        <h2>Número de Reserva Terminado</h2>
        <div id="qrcode"></div>
        <p>Favor pasar por el lector de QR para hacer el cierre de la reserva</p>
    </div>

</div>

<!-- Overlay de carga -->
<div class="overlay" id="loadingOverlay">
    <div class="spinner"></div> Cargando...
</div>

<script>
    var reservaGenerada = ""; // Variable para almacenar el número de reserva asociado al QR generado

    // Actualiza el segundo título con el número de reserva en tiempo real
    function updateNumeroReserva() {
        var numeroReserva = document.getElementById('searchInput').value;
        document.getElementById('numeroReservaTitulo').textContent = 'Número de reserva: ' + numeroReserva;
        checkFinishButtonStatus();  // Revalidar el estado de los botones
    }

    // Simula el proceso de "Terminar todo el proceso"
    function finishProcess() {
        var numeroReserva = document.getElementById('searchInput').value;

        if (reservaGenerada !== numeroReserva) {
            generateQRCode(numeroReserva);
            showLoading();
            setTimeout(function() {
                hideLoading();
                alert('Reserva de stock terminada');
                document.getElementById('qrForm').style.display = 'block';
                reservaGenerada = numeroReserva;  // Registrar la reserva con el QR generado
                document.getElementById('finishButton').disabled = true;  // Deshabilitar el botón "Terminar todo el proceso"
            }, 2000); // 2 segundos de retraso
        } else {
            alert('El QR ya ha sido generado para esta reserva');
        }
    }

    // Mostrar overlay de carga
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    // Ocultar overlay de carga
    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    // Generar el código QR
    function generateQRCode(data) {
        new QRCode(document.getElementById("qrcode"), {
            text: data,
            width: 256,
            height: 256,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
    }

    // Validar si todos los artículos están en "Terminado"
    function checkFinishButtonStatus() {
        var allTerminado = true;
        var rows = document.querySelectorAll('#dataTable tbody tr');
        rows.forEach(function(row) {
            var estado = row.querySelector('td:nth-child(7)').textContent.trim();
            if (estado !== 'Terminado') {
                allTerminado = false;
            }
        });

        var finishButton = document.getElementById('finishButton');
        if (allTerminado) {
            finishButton.disabled = false;
        } else {
            finishButton.disabled = true;
        }
    }

    // Función para cambiar el estado de los artículos
    function changeState(button) {
        var row = button.closest('tr');
        var estadoCell = row.querySelector('td:nth-child(7)');
        var unidadesCell = row.querySelector('td:nth-child(6)'); // Columna "Unidades preparadas"
        var currentState = estadoCell.textContent.trim();

        if (currentState === 'Pendiente') {
            estadoCell.textContent = 'Terminado';
            row.classList.add('completed');
            unidadesCell.querySelector('input').disabled = true; // Deshabilitar edición
        } else {
            estadoCell.textContent = 'Pendiente';
            row.classList.remove('completed');
            unidadesCell.querySelector('input').disabled = false; // Habilitar edición
        }

        checkFinishButtonStatus();
    }

    // Cargar datos de ejemplo
    function loadTableData() {
        var tableBody = document.querySelector('#dataTable tbody');
        var data = [
            ['1', 'A123', 'Artículo 1', '10', '5', '5', 'Pendiente'],
            ['2', 'B234', 'Artículo 2', '20', '10', '10', 'Terminado'],
            ['3', 'C345', 'Artículo 3', '15', '10', '5', 'Pendiente']
        ];

        tableBody.innerHTML = '';

        data.forEach(function(item) {
            var row = document.createElement('tr');
            item.forEach(function(cell, index) {
                var td = document.createElement('td');
                td.textContent = cell;

                // Hacer que "Unidades preparadas" sea editable
                if (index === 5) {
                    var input = document.createElement('input');
                    input.type = 'number';
                    input.value = cell;
                    td.innerHTML = ''; // Limpiar texto
                    td.appendChild(input);
                }

                row.appendChild(td);
            });

            var actionCell = document.createElement('td');
            var actionButton = document.createElement('button');
            actionButton.textContent = 'Cambiar estado';
            actionButton.classList.add('action-button');
            actionButton.onclick = function() { changeState(actionButton); };
            actionCell.appendChild(actionButton);
            row.appendChild(actionCell);
            tableBody.appendChild(row);
        });

        checkFinishButtonStatus();
    }

    // Cargar los datos en la tabla
    loadTableData();
</script>

</body>
</html>
